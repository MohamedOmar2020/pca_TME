mouse_dataInput <- t(py_to_r(adata_mouse)$raw)
# access normalized data matrix
mouse_dataInput <- t(py_to_r(adata_mouse$X$raw))
# access normalized data matrix
mouse_dataInput <- t(py_to_r(adata_mouse$raw$X))
?createCellChat
?computeCommunProb
View(mouse_seurat)
# clean workspace
rm(list = ls())
# load libraries
library(data.table)
library(Seurat)
library(SeuratDisk)
library(CellChat)
library(patchwork)
library(reticulate)
# set the active conda environment
use_condaenv(condaenv = "scutils", required = TRUE)
# load the anndata module
ad <- import("anndata", convert = FALSE)
# load the mouse h5ad object
adata_mouse <- ad$read_h5ad("./forCellChat/fapcm_fibroblasts_v6.h5ad")
# load the mouse h5ad object
adata_mouse <- ad$read_h5ad("./forCellChat/adata_mouse_norm.h5ad")
# access normalized data matrix
mouse_dataInput <- t(py_to_r(adata_mouse$X))
View(adata_mouse)
adata_mouse
# access normalized data matrix
mouse_dataInput <- t(py_to_r(adata_mouse$to_df))
# load the mouse h5ad object
adata_mouse <- ad$read_h5ad("./forCellChat/adata_mouse_norm.h5ad")
# access normalized data matrix
mouse_dataInput <- t(py_to_r(adata_mouse$X))
range(mouse_dataInput)
rownames(mouse_dataInput) <- rownames(py_to_r(adata_mouse$var))
colnames(mouse_dataInput) <- rownames(py_to_r(adata_mouse$obs))
## access meta data
mouse_metaData <- py_to_r(adata_mouse$obs)
mouse_meta <- mouse_metaData
# some cleaning
mouse_meta$cluster <- paste0("c", mouse_meta$cluster)
mouse_meta <- mouse_meta[!(mouse_meta$cluster == 'cNA'), ]
mouse_dataInput <- mouse_dataInput[, rownames(mouse_meta)]
#############################################
# creat a cellchat object
cellchat_mouse <- createCellChat(object = mouse_dataInput, meta = mouse_meta, group.by = "cluster")
# Add cell information into meta slot of the object (Optional)
cellchat_mouse <- addMeta(cellchat_mouse, meta = mouse_meta)
cellchat_mouse <- setIdent(cellchat_mouse, ident.use = "cluster") # set "labels" as default cell identity
levels(cellchat_mouse@idents) # show factor levels of the cell labels
groupSize <- as.numeric(table(cellchat_mouse@idents)) # number of cells in each cell group
# Set the ligand-receptor interaction database
CellChatDB <- CellChatDB.mouse
showDatabaseCategory(CellChatDB)
table(cellchat_mouse@idents)
# Set the ligand-receptor interaction database
CellChatDB <- CellChatDB.mouse
showDatabaseCategory(CellChatDB)
# Show the structure of the database
dplyr::glimpse(CellChatDB$interaction)
# set the used database in the object
CellChatDB.use <- CellChatDB
cellchat_mouse@DB <- CellChatDB.use
#################################################
# Preprocessing the expression data for cell-cell communication analysis
# subset the expression data of signaling genes for saving computation cost
cellchat_mouse <- subsetData(cellchat_mouse) # This step is necessary even if using the whole database
future::plan("multicore", workers = 5) # do parallel
cellchat_mouse <- identifyOverExpressedGenes(cellchat_mouse)
cellchat_mouse <- identifyOverExpressedInteractions(cellchat_mouse)
# project gene expression data onto PPI network (optional)
cellchat_mouse <- projectData(cellchat_mouse, PPI.mouse)
# Compute the communication probability and infer cellular communication network
cellchat_mouse <- computeCommunProb(cellchat_mouse)
# Filter out the cell-cell communication if there are only few number of cells in certain cell groups
cellchat_mouse <- filterCommunication(cellchat_mouse, min.cells = 10)
# Infer the cell-cell communication at a signaling pathway level
cellchat_mouse <- computeCommunProbPathway(cellchat_mouse)
# Calculate the aggregated cell-cell communication network
cellchat_mouse <- aggregateNet(cellchat_mouse)
#  visualize the aggregated cell-cell communication network:  the number of interactions or the total interaction strength (weights) between any two cell groups using circle plot.
groupSize <- as.numeric(table(cellchat_mouse@idents))
par(mfrow = c(1,2), xpd=TRUE)
netVisual_circle(cellchat_mouse@net$count, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Number of interactions")
netVisual_circle(cellchat_mouse@net$weight, vertex.weight = groupSize, weight.scale = T, label.edge= F, title.name = "Interaction weights/strength")
###########
# examine the signaling sent from each cell group.
mat <- cellchat_mouse@net$weight
par(mfrow = c(3,4), xpd=TRUE)
###########
# examine the signaling sent from each cell group.
mat_mouse <- cellchat_mouse@net$weight
par(mfrow = c(3,4), xpd=TRUE)
for (i in 1:nrow(mat_mouse)) {
mat2 <- matrix(0, nrow = nrow(mat_mouse), ncol = ncol(mat_mouse), dimnames = dimnames(mat_mouse))
mat2[i, ] <- mat_mouse[i, ]
netVisual_circle(mat2, vertex.weight = groupSize, weight.scale = T, edge.weight.max = max(mat_mouse), title.name = rownames(mat_mouse)[i])
}
View(mat2)
View(mat2)
View(mat_mouse)
View(mat)
## Get the dataframes of communications at the L/R level
df.net_mouse <- subsetCommunication(cellchat_mouse)
## Get the dataframes of communications at the pathway level
df.net_mouse_pathway <- subsetCommunication(cellchat_mouse, slot.name = "netP")
View(df.net_mouse)
View(df.net_mouse_pathway)
table(df.net_mouse_pathway$pathway_name)
# Visualization of cell-cell communication network
pathways.show <- c("WNT", "ncWNT")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1,4) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver)
# Visualization of cell-cell communication network
pathways.show <- c("WNT", "ncWNT")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1,4) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver)
graphics.off()
pathways.show <- c("WNT", "ncWNT")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1,4) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver)
# Visualization of cell-cell communication network
pathways.show <- c("WNT")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1,4) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver)
?netVisual_aggregate
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(3,4) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(4,5) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver, layout = 'hierarchy')
View(cellchat_mouse)
View(df.net_mouse)
cellchat_mouse@idents
table(cellchat_mouse@idents)
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1,2) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show,  vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(1,2) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(4,5) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Circle plot
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "circle")
# Chord diagram
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "chord")
# all the pathways
table(df.net_mouse_pathway$pathway_name)
# Visualization of cell-cell communication network
pathways.show <- c("ncWNT")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(4,5) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Chord diagram
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "chord")
netVisual_heatmap(cellchat_mouse, signaling = pathways.show, color.heatmap = "Reds")
# Heatmap
par(mfrow=c(1,1))
netVisual_heatmap(cellchat_mouse, signaling = pathways.show, color.heatmap = "Reds")
# Visualization of cell-cell communication network
pathways.show <- c("FGF")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(4,5) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "chord")
# Chord diagram
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "chord")
# Visualization of cell-cell communication network
pathways.show <- c("VCAM")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(4,5) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Circle plot
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "circle")
# Chord diagram
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "chord")
# Visualization of cell-cell communication network
pathways.show <- c("TGFb")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(6,7, 8) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Visualization of cell-cell communication network
pathways.show <- c("TGFb")
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(6,7,8) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(6,7) # a numeric vector.
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, vertex.receiver = vertex.receiver, layout = 'hierarchy')
# Hierarchy plot
# Here we define `vertex.receive` so that the left portion of the hierarchy plot shows signaling to fibroblast and the right portion shows signaling to immune cells
vertex.receiver = seq(6,7, 8) # a numeric vector.
# Chord diagram
par(mfrow=c(1,1))
netVisual_aggregate(cellchat_mouse, signaling = pathways.show, layout = "chord")
# Chord diagram by cell
group.cellType <- c(rep("FIB", 4), rep("DC", 4), rep("TC", 4)) # grouping cell clusters into fibroblast, DC and TC cells
group.cellType
graphics.off()
graphics.off()
library(data.table)
library(readxl)
library(ggplot2)
library(patchwork)
rm(list = ls())
1442/8980
2541/8980
310/8980
903/8980
733/8980
997/8980
895/8980
753/8980
934/8628
2231/8628
54/8628
189/8628
95/8628
62/8628
4029/8628
520/8628
1442/8574
2541/8574
310/8574
903/8574
733/8574
997/8574
895/8574
753/8574
1151/8628
2558/8628
68/8628
152/8628
59/8628
3976/8628
514/8628
rm(list = ls())
Sys.setenv(RETICULATE_PYTHON = "/Users/mohamedomar/opt/anaconda3/envs/scutils/bin/python3.10")
library(reticulate)
library(data.table)
library(readxl)
library(ggplot2)
library(patchwork)
library(projectR)
library(Seurat)
library(SeuratDisk)
library(tools)
library(stringr)
library(scater)
library(scran)
library(projectR)
############################################################
# conda env and scanpy
use_condaenv(condaenv = "scutils", required = TRUE)
sc <- import("scanpy")
scp <- import('scipy')
## convert the human h5ad to seurat
mouse_adata <- sc$read_h5ad('outs/h5ads/fapcm_fibroblasts_v6_clean_regulons_5.h5ad')
counts <- scp$sparse$csr_matrix$todense(mouse_adata$layers['counts'])
counts <- t(counts)
#counts <- t(mouse_adata$layers['counts'])
colnames(counts) <-  mouse_adata$obs_names$to_list()
rownames(counts) <-  mouse_adata$var_names$to_list()
rownames(counts) <- str_to_title(rownames(counts))
counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
# counts <- scp$sparse$csr_matrix$todense(mouse_adata$raw$X)
# counts <- t(counts)
# colnames(counts) <-  mouse_adata$raw$obs_names$to_list()
# rownames(counts) <-  mouse_adata$raw$var_names$to_list()
# counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
mouse_obj <- CreateSeuratObject(counts)
mouse_obj <- AddMetaData(mouse_obj,  mouse_adata$obs)
# Remove the unlabelled libraries here.
mouse_obj <- mouse_obj[,!is.na(mouse_obj$cluster)]
############
## convert the human h5ad to seurat
human_adata <- sc$read_h5ad('./human/erg_fibroblasts_scvi_v6_regulons2.h5ad')
# counts <- scp$sparse$csr_matrix$todense(human_adata$raw$X)
# counts <- t(counts)
# colnames(counts) <-  human_adata$raw$obs_names$to_list()
# rownames(counts) <-  human_adata$raw$var_names$to_list()
# rownames(counts) <- str_to_title(rownames(counts))
# counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
counts <- scp$sparse$csr_matrix$todense(human_adata$layers['counts'])
counts <- t(counts)
colnames(counts) <-  human_adata$obs_names$to_list()
rownames(counts) <-  human_adata$var_names$to_list()
rownames(counts) <- str_to_title(rownames(counts))
counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
human_obj <- CreateSeuratObject(counts)
human_obj <- AddMetaData(human_obj,  human_adata$obs)
######################################
## Obtaining PCs to project
mouse_mat <- as.matrix(mouse_obj@assays$RNA@counts)
mouse_metadata <- mouse_obj
# do PCA on mouse expression data
pc_mouse<-prcomp(t(mouse_mat))
pcVAR <- round(((pc_mouse$sdev)^2/sum(pc_mouse$sdev^2))*100,2)
dPCA <- data.frame(cbind(pc_mouse$x,pd.RNAseq6l3c3t))
#plot pca
dPCA <- data.frame(cbind(pc_mouse$x,mouse_metadata))
#plot pca
library(ggplot2)
#setCOL <- scale_colour_manual(values = c("blue","black","red"), name="Condition:")
#setFILL <- scale_fill_manual(values = c("blue","black","red"),guide = FALSE)
setPCH <- scale_shape_manual(values=c(23,22,25,25,21,24),name="Cell Line:")
pPCA <- ggplot(dPCA, aes(x=PC1, y=PC2, colour=ID.cond, shape=ID.line,
fill=ID.cond)) +
geom_point(alpha=.6)+
setCOL + setPCH + setFILL +
scale_size_area(breaks = c(2,4,6), name="Day") +
theme(legend.position=c(0,0), legend.justification=c(0,0),
legend.direction = "horizontal",
panel.background = element_rect(fill = "white",colour=NA),
legend.background = element_rect(fill = "transparent",colour=NA),
plot.title = element_text(vjust = 0,hjust=0,face="bold")) +
labs(title = "PCA of hPSC PolyA RNAseq",
x=paste("PC1 (",pcVAR[1],"% of varience)",sep=""),
y=paste("PC2 (",pcVAR[2],"% of varience)",sep=""))
#setCOL <- scale_colour_manual(values = c("blue","black","red"), name="Condition:")
#setFILL <- scale_fill_manual(values = c("blue","black","red"),guide = FALSE)
#setPCH <- scale_shape_manual(values=c(23,22,25,25,21,24),name="Cell Line:")
pPCA <- ggplot(dPCA, aes(x=PC1, y=PC2, colour=ID.cond,
fill=cluster)) +
geom_point(alpha=.6)+
#setCOL + setPCH + setFILL +
scale_size_area(breaks = c(2,4,6), name="Day") +
theme(legend.position=c(0,0), legend.justification=c(0,0),
legend.direction = "horizontal",
panel.background = element_rect(fill = "white",colour=NA),
legend.background = element_rect(fill = "transparent",colour=NA),
plot.title = element_text(vjust = 0,hjust=0,face="bold")) +
labs(title = "PCA of hPSC PolyA RNAseq",
x=paste("PC1 (",pcVAR[1],"% of varience)",sep=""),
y=paste("PC2 (",pcVAR[2],"% of varience)",sep=""))
pPCA
#setCOL <- scale_colour_manual(values = c("blue","black","red"), name="Condition:")
#setFILL <- scale_fill_manual(values = c("blue","black","red"),guide = FALSE)
#setPCH <- scale_shape_manual(values=c(23,22,25,25,21,24),name="Cell Line:")
pPCA <- ggplot(dPCA, aes(x=PC1, y=PC2, colour=cluster,
fill=cluster)) +
geom_point(alpha=.6)+
#setCOL + setPCH + setFILL +
scale_size_area(breaks = c(2,4,6), name="Day") +
theme(legend.position=c(0,0), legend.justification=c(0,0),
legend.direction = "horizontal",
panel.background = element_rect(fill = "white",colour=NA),
legend.background = element_rect(fill = "transparent",colour=NA),
plot.title = element_text(vjust = 0,hjust=0,face="bold")) +
labs(title = "PCA of hPSC PolyA RNAseq",
x=paste("PC1 (",pcVAR[1],"% of varience)",sep=""),
y=paste("PC2 (",pcVAR[2],"% of varience)",sep=""))
pPCA
dPCA <- data.frame(cbind(pc_mouse$x, mouse_metadata))
tail(colnames(dPCA))
tail(colnames(dPCA), 100)
colnames(pc_mouse)
dim(pc_mouse)
colnames(pc_mouse$x)
mouse_metadata
mouse_metadata <- mouse_obj@meta.data
dPCA <- data.frame(cbind(pc_mouse$x, mouse_metadata))
#setCOL <- scale_colour_manual(values = c("blue","black","red"), name="Condition:")
#setFILL <- scale_fill_manual(values = c("blue","black","red"),guide = FALSE)
#setPCH <- scale_shape_manual(values=c(23,22,25,25,21,24),name="Cell Line:")
pPCA <- ggplot(dPCA, aes(x=PC1, y=PC2, colour=cluster,
fill=cluster)) +
geom_point(alpha=.6)+
#setCOL + setPCH + setFILL +
scale_size_area(breaks = c(2,4,6), name="Day") +
theme(legend.position=c(0,0), legend.justification=c(0,0),
legend.direction = "horizontal",
panel.background = element_rect(fill = "white",colour=NA),
legend.background = element_rect(fill = "transparent",colour=NA),
plot.title = element_text(vjust = 0,hjust=0,face="bold")) +
labs(title = "PCA of hPSC PolyA RNAseq",
x=paste("PC1 (",pcVAR[1],"% of varience)",sep=""),
y=paste("PC2 (",pcVAR[2],"% of varience)",sep=""))
pPCA
#setCOL <- scale_colour_manual(values = c("blue","black","red"), name="Condition:")
#setFILL <- scale_fill_manual(values = c("blue","black","red"),guide = FALSE)
#setPCH <- scale_shape_manual(values=c(23,22,25,25,21,24),name="Cell Line:")
pPCA <- ggplot(dPCA, aes(x=PC1, y=PC2, colour=cluster,
fill=cluster)) +
geom_point(alpha=.6)+
#setCOL + setPCH + setFILL +
scale_size_area(breaks = c(2,4,6), name="Day") +
theme(legend.position=c(0,0), legend.justification=c(0,0),
legend.direction = "horizontal",
panel.background = element_rect(fill = "white",colour=NA),
legend.background = element_rect(fill = "transparent",colour=NA),
plot.title = element_text(vjust = 0,hjust=0,face="bold")) +
labs(title = "PCA of mouse clusters",
x=paste("PC1 (",pcVAR[1],"% of varience)",sep=""),
y=paste("PC2 (",pcVAR[2],"% of varience)",sep=""))
pPCA
View(dPCA)
?projectR
pPCA
View(dPCA)
#############################################
## Projection
# data to project into PCs from human expression data
human_mat <- as.matrix(human_obj@assays$RNA@counts)
mouse_metadata <- human_obj@meta.data
# commonGns
commonGns <- intersect(rownames(mouse_mat), rownames(human_mat))
PCA2ESepi <- projectR(data = human_mat,loadings=pc_mouse,
full = TRUE, dataNames = commonGns)
PCA2ESepi <- projectR(data = human_mat,loadings=pc_mouse,
full = TRUE, dataNames = rownames(human_mat))
ls
rm(list = ls())
Sys.setenv(RETICULATE_PYTHON = "/Users/mohamedomar/opt/anaconda3/envs/scutils/bin/python3.10")
library(reticulate)
library(data.table)
library(readxl)
library(ggplot2)
library(patchwork)
library(projectR)
library(Seurat)
library(SeuratDisk)
library(tools)
library(stringr)
library(scater)
library(scran)
library(projectR)
############################################################
# conda env and scanpy
use_condaenv(condaenv = "scutils", required = TRUE)
sc <- import("scanpy")
scp <- import('scipy')
## convert the human h5ad to seurat
mouse_adata <- sc$read_h5ad('outs/h5ads/fapcm_fibroblasts_v6_clean_regulons_5.h5ad')
counts <- scp$sparse$csr_matrix$todense(mouse_adata$layers['counts'])
counts <- t(counts)
#counts <- t(mouse_adata$layers['counts'])
colnames(counts) <-  mouse_adata$obs_names$to_list()
rownames(counts) <-  mouse_adata$var_names$to_list()
rownames(counts) <- str_to_title(rownames(counts))
counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
# counts <- scp$sparse$csr_matrix$todense(mouse_adata$raw$X)
# counts <- t(counts)
# colnames(counts) <-  mouse_adata$raw$obs_names$to_list()
# rownames(counts) <-  mouse_adata$raw$var_names$to_list()
# counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
mouse_obj <- CreateSeuratObject(counts)
mouse_obj <- AddMetaData(mouse_obj,  mouse_adata$obs)
# Remove the unlabelled libraries here.
mouse_obj <- mouse_obj[,!is.na(mouse_obj$cluster)]
############
## convert the human h5ad to seurat
human_adata <- sc$read_h5ad('./human/erg_fibroblasts_scvi_v6_regulons2.h5ad')
# counts <- scp$sparse$csr_matrix$todense(human_adata$raw$X)
# counts <- t(counts)
# colnames(counts) <-  human_adata$raw$obs_names$to_list()
# rownames(counts) <-  human_adata$raw$var_names$to_list()
# rownames(counts) <- str_to_title(rownames(counts))
# counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
counts <- scp$sparse$csr_matrix$todense(human_adata$layers['counts'])
counts <- t(counts)
colnames(counts) <-  human_adata$obs_names$to_list()
rownames(counts) <-  human_adata$var_names$to_list()
rownames(counts) <- str_to_title(rownames(counts))
counts <- Matrix::Matrix(as.matrix(counts), sparse = T)
human_obj <- CreateSeuratObject(counts)
human_obj <- AddMetaData(human_obj,  human_adata$obs)
# commonGns
commonGns <- intersect(rownames(mouse_mat), rownames(human_mat))
######################################
## Obtaining PCs to project
mouse_mat <- as.matrix(mouse_obj@assays$RNA@counts)
mouse_metadata <- mouse_obj@meta.data
# do PCA on mouse expression data
pc_mouse<-prcomp(t(mouse_mat))
pcVAR <- round(((pc_mouse$sdev)^2/sum(pc_mouse$sdev^2))*100,2)
dPCA <- data.frame(cbind(pc_mouse$x, mouse_metadata))
